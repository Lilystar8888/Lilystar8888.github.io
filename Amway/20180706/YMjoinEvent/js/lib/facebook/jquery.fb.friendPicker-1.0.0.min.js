(function(n){typeof define=="function"&&define.amd?define(["jquery","tinyscrollbar"],n):n(jQuery)})(function(n){var t={init:function(i){var r=n.extend(!0,{},n.fn.friendPicker.settings,i);return this.each(function(){var e=this,u=n(this).data("settings",r),i,f;n.each("itemClick itemDoubleClick itemPicked itemUnpicked itemOverPick listReady afterSearch ready".split(" "),function(t,i){var f=i.replace(/[A-Z]/g,function(n){return"-"+n.toLowerCase()});if(n.isFunction(r[i]))u.on(f,r[i])});i=n(this).empty();f=n('<div class="'+r.frienBoxClass+'">');r.customScroll?(i.append('<div class="searchbox clearfix"><span>朋友搜尋<\/span> <input type="text" class="'+r.searchBoxClass+'" /><\/div>').append('<div class="scroll"><div class="scrollbar"><div class="track"><div class="thumb"><div class="end"><\/div><\/div><\/div><\/div><div class="viewport"><div class="overview"><\/div><\/div><\/div>'),n(".overview").append(f),i.find(".scroll").tinyscrollbar()):i.append('<input type="text" class="'+r.searchBoxClass+'" placeholder="朋友搜尋" />').append(f);i.data("friendBox",f).on("click","."+r.itemClass,function(f){if(r.multiSelect){var o=n(this),s=t.getPickedItems.apply(i,Array.prototype.slice.call(arguments,1));r.max==1&&s.length>0?o.hasClass("picked")?(o.removeClass("picked"),u.trigger("item-unpicked",[this])):(n(s[0]).removeClass("picked"),o.addClass("picked"),u.trigger("item-picked",[this])):o.hasClass(r.pickedClass)||s.length<r.max?o.hasClass("picked")?(o.removeClass("picked"),u.trigger("item-unpicked",[this])):(o.addClass("picked"),u.trigger("item-picked",[this])):u.trigger("item-over-pick",[this])}else{if(n.isFunction(r.itemClick))return r.itemClick.call(e,f);u.trigger("item-click",[this])}}).on("dblclick","."+r.itemClass,function(){u.trigger("item-double-click",[this])}).on("mouseenter","."+r.itemClass,function(){n(this).addClass(r.mouseenterClass)}).on("mouseleave","."+r.itemClass,function(){n(this).removeClass(r.mouseenterClass)}).on("keyup blur focus","."+r.searchBoxClass,function(){var f=n(this).val().toLowerCase(),t=i.find("."+r.itemClass).filter(function(){var t=n(this),i=t.text().toLowerCase().indexOf(f)>-1;return t.toggle(i),i}).size();t!=i.data("last-count")&&(i.data("last-count",t),u.trigger("after-search",[this]));r.customScroll&&i.find(".scroll").tinyscrollbar_update()}).trigger("ready");t.refresh.apply(this,Array.prototype.slice.call(arguments,1))})},refresh:function(){var i=n(this),t=i.data("settings"),r=i.data("friendBox"),u;t&&r&&(r.empty().append(n('<div class="'+t.loadingClass+'"/>')),u="pic"+(t.avatarType==""?"":"_"+t.avatarType),FB.api("/fql",{q:"select name, uid, "+u+" from user where uid in (select uid2 from friend where uid1 = me()) order by name limit "+~~t.friendLimit},function(f){var o,e,s;if((!f||f.error)&&console)return console.log(f.error.message);o=n('<ul class="'+t.ulClass+'">');e=n.Deferred();t.recentlyFirst?(s=setTimeout(function(){e.resolve({})},t.recentlyTimeout*1e3),FB.api("me/posts?limit="+t.recentlyLimit,function(t){clearTimeout(s);var i={};n.each((t||{}).data||[],function(t,r){r=r||{};var u=r.likes||{};n.each(u.data||[],function(n,t){var r=t.id||"0",u=i[r]||{id:r,cnt:0};u.cnt++;i[r]=u});u=r.comments||{};n.each(u.data||[],function(n,t){t=t||{};t.form=t.form||{};var r=t.from.id||"0",u=i[r]||{id:r,cnt:0};u.cnt++;i[r]=u})});e.resolve(i)})):e.resolve({});e.done(function(e){n.each(f.data||[],function(i,r){var f=n("<li />").addClass(t.itemClass).data("fid",r.uid).data("fname",r.name).append(n("<img />").attr({alt:r.uid,src:r[u]}).addClass(t.avatarClass)).append(n("<div />").text(r.name).addClass(t.nameClass)),r=e[this.uid];r?r.li=f.addClass("recently"):f.appendTo(o)});e=n.map(e,function(n){if(n.li)return n});e.sort(function(n,t){return t.cnt-n.cnt});o.prepend(n.map(e,function(n){return n.li})).appendTo(r.empty());i.trigger("list-ready");t.customScroll&&i.find(".scroll").tinyscrollbar_update()})}))},getItems:function(){var i=n(this).data("settings"),t=n(this).data("friendBox");return t.find("li")},getPickedItems:function(){var t=n(this).data("settings"),i=n(this).data("friendBox");return i.find("."+t.pickedClass)},destroy:function(){return n(this).empty()}};n.fn.friendPicker=function(i){if(t[i])return t[i].apply(this,Array.prototype.slice.call(arguments,1));if(typeof i!="object"&&i)n.error("Method "+i+" does not exist on jQuery.friendPicker");else return t.init.apply(this,arguments)};n.fn.friendPicker.settings={frienBoxClass:"friends",ulClass:"clearfix",searchBoxClass:"search",pickedClass:"picked",avatarClass:"avatar",avatarType:"square",itemClass:"item",nameClass:"name",mouseenterClass:"select",loadingClass:"loading",max:1,multiSelect:!0,friendLimit:3e3,recentlyFirst:!1,recentlyLimit:100,recentlyTimeout:15,customScroll:!0}});