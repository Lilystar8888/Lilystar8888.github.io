(function(a){typeof define==="function"&&define.amd?define(["jquery","tinyscrollbar"],a):a(jQuery)})(function(a){a.fn.photoPicker=function(c){if(b[c])return b[c].apply(this,Array.prototype.slice.call(arguments,1));else if(typeof c==="object"||!c)return b.init.apply(this,arguments);else a.error("Method "+c+" does not exist on jQuery.photoPicker")};a.fn.photoPicker.defaultSettings={albumUseBackground:true,photoUseBackground:true,albumPageSize:1e3,photoPageSize:5e3,albumImageType:"album",photoImageType:"thumbnail",loadingPic:"//www.facebook.com/images/loaders/indicator_blue_large.gif",albumPrevText:"&laquo;prev",albumNextText:"next&raquo",photoNextText:"&laquo;prev",photoNextText:"next&laquo;",albumSelected:function(){},prevAlbumPage:function(){},nextAlbumPage:function(){},photoSelected:function(){},prevPhotoPage:function(){},nextPhotoPage:function(){}};var b={init:function(g){var f=a.extend({},a.fn.photoPicker.defaultSettings,g),i={currentAlbumPage:1,maxAlbumPage:1,currentPhotoPage:1,maxPhotoPage:1},h=function(){var k=this,g=a(k).empty().data("settings",f).data("state",i),h=a('<div class="album-area"/>').append('<div class="scroll"><div class="scrollbar"><div class="track"><div class="thumb"><div class="end"></div></div></div></div><div class="viewport"><div class="overview"></div></div></div>').appendTo(g);a(".album-area .overview").append('<ul class="albums"/>').append('<a class="album-prev" href="#">prev</a>').append('<a class="album-next" href="#">next</a>');a(this).data("albumArea",h);var j=a('<div class="photo-area"/>').append('<div class="scroll"><div class="scrollbar disable"><div class="track"><div class="thumb"><div class="end"></div></div></div></div><div class="viewport"><div class="overview"></div></div></div>').appendTo(g);a(".photo-area .overview").append('<ul class="photos"/>').append('<a class="photo-prev" href="#">prev</a>').append('<a class="photo-next" href="#">next</a>');a(this).data("photoArea",j);h.find(".scroll").tinyscrollbar();j.find(".scroll").tinyscrollbar();g.on("click",".album-prev",function(a){a.preventDefault();var b=g.data("state");if(b.currentAlbumPage>1){jQuery.isFunction(f.prevAlbumPage)&&f.prevAlbumPage.call(this,a);b.currentAlbumPage-=1;c(g)}}).on("click",".album-next",function(b){b.preventDefault();var a=g.data("state");if(a.currentAlbumPage<a.maxAlbumPage){jQuery.isFunction(f.nextAlbumPage)&&f.nextAlbumPage.call(this,b);a.currentAlbumPage+=1;c(g)}}).on("click",".album-area .albums li",function(b){b.preventDefault();var d=g.data("state"),c=a(this).data("aid");a(this).siblings().removeClass("active").end().addClass("active");jQuery.isFunction(f.albumSelected)&&f.albumSelected.call(this,b);e(g,c)}).on("click",".photo-prev",function(a){a.preventDefault();var b=g.data("state");if(b.currentPhotoPage>1){jQuery.isFunction(f.prevPhotoPage)&&f.prevPhotoPage.call(this,a);b.currentPhotoPage-=1;d(g)}}).on("click",".photo-next",function(b){b.preventDefault();var a=g.data("state");if(a.currentPhotoPage<a.maxPhotoPage){jQuery.isFunction(f.nextPhotoPage)&&f.nextPhotoPage.call(this,b);a.currentPhotoPage+=1;d(g)}}).on("click",".photo-area .photos li",function(b){b.preventDefault();a(this).siblings().removeClass("active").end().addClass("active");jQuery.isFunction(f.photoSelected)&&f.photoSelected.call(this,b)});FB.getLoginStatus(function(a){if(a.status=="connected"){g.data("access_token",encodeURIComponent(a.authResponse.accessToken));b.refresh.apply(k,Array.prototype.slice.call(arguments,1))}})};return this.each(h)},refresh:function(){var b=a(this),e=b.data("settings"),d=b.data("state"),f=b.data("albumArea"),g=b.data("photoArea");FB.api("/fql",{q:"select aid, cover_pid, name from album where owner = me()"},function(f){if(f&&!f.error){f=f.data;d.maxAlbumPage=Math.ceil(f.length/e.albumPageSize);if(f.length>0){d.currentAlbumPage=1;b.data("albums",f);FB.api("/fql",{q:"select pid, src_small from photo where pid in (select cover_pid from album where owner = me())"},function(d){if(d&&!d.error){d=d.data;var e={};console.log();a.each(d,function(b,a){e[a.pid]=a.src_small});b.data("covers",e);c(b)}else console&&console.log(d.error.message)})}else d.currentAlbumPage=0}else console&&console.log(f.error.message)})},getAlbums:function(){var b=a(this);return b.data("albums")},getPhotos:function(){var b=a(this),c=b.data("settings")},destroy:function(){return a(this).empty()}},c=function(b){var e=b.data("settings"),j=b.data("state"),l=b.data("access_token"),d=e.albumPageSize,i=b.data("albums"),f=b.data("covers"),h=b.data("albumArea").find("ul.albums").empty(),g=d*(j.currentAlbumPage-1),k=g+d,c=i.slice(g,k);a(c).each(function(d,c){if(!f[c.cover_pid])return true;img_src=f[c.cover_pid]||"//www.facebook.com/images/photos/empty-album.png";var b=a("<li/>").data("aid",c.aid);if(e.albumUseBackground)b.append(a('<div class="item"/>').css("background-image","url("+img_src+")"));else b.append(a("<img/>").attr("src",img_src));h.append(b.append(a('<span class="alubmName"/>').text(this.name)))});b.find(".album-area .scroll").tinyscrollbar_update();c.length>0&&b.find(".album-area .albums li:eq(0)").click()},e=function(a,f){var b=a.data("settings"),c=a.data("state"),e=a.data("photoArea");e.css("background","#fff no-repeat url("+b.loadingPic+") center center").find("ul.photos").empty();FB.api("/fql",{q:'select pid, src_small,src_big,src,caption from photo where aid = "'+f+'" limit '+~~b.photoPageSize},function(e){if(e&&!e.error){var f=e.data;a.data("photos",f);c.maxPhotoPage=Math.ceil(f.length/b.photoPageSize);if(f.length>0){c.currentPhotoPage=1;d(a)}else c.currentPhotoPage=0}else window.console&&console.log(e.error.message)})},d=function(b){var d=b.data("settings"),i=b.data("state"),k=b.data("access_token"),c=d.photoPageSize,h=b.data("photos"),g=b.data("photoArea").css("background-image","none").find("ul.photos").empty(),e=c*(i.currentPhotoPage-1),j=e+c,f=h.slice(e,j);a(f).each(function(f,e){var c=e.src_small,b=a("<li/>").data("src_big",e.src_big);if(d.photoUseBackground)b.append(a('<div class="item"/>').css("background-image","url("+c+")"));else b.append(a("<img/>").attr("src",c));g.append(b)});b.find(".photo-area .scroll").tinyscrollbar_update()}})