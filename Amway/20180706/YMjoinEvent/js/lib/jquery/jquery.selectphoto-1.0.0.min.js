(function(a){typeof define==="function"&&define.amd?define(["jquery","extend","exif","megapix","resumable","swfobject"],a):a(jQuery)})(function(){var b="isobar_selectphoto";$.fn.selectPhoto=function(c){if(typeof c=="string"){var d=Array.prototype.slice.call(arguments,1);return this.each(function(){var a=$(this).data(b);a&&a[c]&&a[c].apply(a,d)})}else return this.each(function(){var d=new a;d._setting=$.extend(true,{},$.fn.selectPhoto.settings,c);d._element=this;d._init();$(this).data(b,d)})};$.fn.selectPhoto.settings={maxLength:1920,maxSize:5,useType:"auto",token:"a"+(Math.random()*(1<<30)).toString(16).replace(".",""),isFlashShowPic:false,isAPIShowLoading:true,isMegapixUseServer:true};$.fn.selectPhoto.events={PHOTO:"selectphoto:photo",CLICK:"selectphoto:click",PROGRESS:"selectphoto:progress"};function a(){}var c=0;$.extend(a.prototype,{_setting:$.fn.selectPhoto.settings,_element:null,_elmMegapixFile:null,_b64ToServerURL:function(b){var a=this;$.callAPI($.resolve("~/api/B64File.ashx"),{b64:b},{isHideLoading:!a._setting.isAPIShowLoading}).done(function(b){a._triggerOnPhoto(b.url)})},_triggerOnPhoto:function(b){var a=this;$("<img />").attr("data-source",b).load(function(){$(a._element).trigger($.fn.selectPhoto.events.PHOTO,[this])}).error(function(){$(a._element).trigger($.fn.selectPhoto.events.PHOTO,[this])}).attr("src",$.resolve(b))},_init:function(){var a=this;c++;a._setting.token+="_"+c;if(a._setting.useType=="resumable"||a._setting.useType=="auto"&&$.isMobile){var b=window.resumable=new Resumable({target:$.resolve("~/api/ResumableFile.ashx"),query:{UploadToken:a._setting.token,MaxLength:a._setting.maxLength},testChunks:false,chunkSize:.3*(1024*1024),simultaneousUploads:1,maxFiles:1,maxFileSize:a._setting.maxSize*(1024*1024),maxChunkRetries:20,chunkRetryInterval:2e3,maxFilesErrorCallback:function(b,a){console.log("maxFilesErrorCallback",b,a);alert("\u8acb\u9078\u64c7\u4e00\u500b\u8981\u4e0a\u50b3\u7684\u7167\u7247!")},maxFileSizeErrorCallback:function(b,a){console.log("maxFileSizeErrorCallback",b,a);alert("\u6a94\u6848\u5927\u5c0f\u8d85\u904e\u9650\u5236!")}});b.assignBrowse(a._element);$(a._element).find('input[type="file"]').attr("accept","image/*").on("click",function(){$(a._element).trigger($.fn.selectPhoto.events.CLICK,[])});b.on("fileAdded",function(a){console.log("fileAdded",a);if(a.chunks.length>0&&a.chunks[0].fileObjType.indexOf("image")<0){b.removeFile(a);alert("\u8acb\u9078\u64c7\u4e00\u500b\u8981\u4e0a\u50b3\u7684\u7167\u7247!");return}b.upload()});b.on("uploadStart",function(){console.log("uploadStart");a._setting.isAPIShowLoading&&$.loading()});b.on("fileProgress",function(b){$(a._element).trigger($.fn.selectPhoto.events.PROGRESS,[~~(b.progress()*100)])});function d(c){b.removeFile(c);a._setting.isAPIShowLoading&&$.loading("hide");alert("\u4e0a\u50b3\u5931\u6557\u8acb\u91cd\u65b0\u6311\u9078\u7167\u7247\u4e0a\u50b3!")}b.on("fileError",function(a,b){console.log("fileError",b,a);d(a)});b.on("fileSuccess",function(e,f){console.log("fileSuccess",e,JSON.parse(f));b.removeFile(e);var c=JSON.parse(f);if(c.success&&c.finished)a._triggerOnPhoto(c.url);else d(e);a._setting.isAPIShowLoading&&$.loading("hide")});a._setting.useType="resumable"}else{var e=typeof FileReader!=="undefined"&&typeof File!=="undefined"&&typeof Blob!=="undefined"&&typeof FileList!=="undefined"&&(!!Blob.prototype.webkitSlice||!!Blob.prototype.mozSlice||!!Blob.prototype.slice||false);if(a._setting.useType=="megapix"||a._setting.useType=="auto"&&e){a._elmMegapixFile=$('<input id="'+a._setting.token+'" type="file" />').attr("accept","image/*").css({position:"absolute",top:"-9999px",display:"none"}).appendTo("body").on("change",function(b){if(b.target.files.length==0)return;var d=b.target.files[0],c=new FileReader;c.onload=function(){var c=EXIF.readFromBinaryFile(new BinaryFile(this.result));mpImg=new MegaPixImage(d);var b=new Image;b.onload=function(){if(a._setting.isMegapixUseServer){var c=b.src.split(",")[1];if(c.length*6/8>a._setting.maxSize*1024*1024){alert("\u4e0a\u50b3\u7684\u7167\u7247\u8d85\u904e\u6a94\u6848\u5927\u5c0f\u9650\u5236!");return}a._b64ToServerURL(c)}else $(a._element).trigger($.fn.selectPhoto.events.PHOTO,[this])};mpImg.render(b,$.extend({orientation:c.Orientation},a._setting.maxLength>0?{maxWidth:a._setting.maxLength,maxHeight:a._setting.maxLength}:{}))};c.readAsText(d);b.target.value=""}).get(0);$(a._element).on("click",function(){$(a._element).trigger($.fn.selectPhoto.events.CLICK,[]);$(a._elmMegapixFile).trigger("click")});a._setting.useType="megapix"}else{var l=$(a._element).outerWidth(),i=$(a._element).outerHeight(),k=$(a._element).offset().top,j=$(a._element).offset().left;$('<div class="flashbox" />').css({position:"absolute",width:l+"px",height:i+"px",top:k+"px",left:j+"px"}).append('<div id="'+a._setting.token+'"></div>').insertAfter(a._element);var h={quality:"high",scale:"noscale",wmode:"transparent",allowscriptaccess:"always",bgcolor:"#000000"},g={base:$.static("~/flash/"),maxSize:a._setting.maxSize,maxLength:a._setting.maxLength,onClick:"onFlashUploadClick_"+a._setting.token,onComplete:"onFlashUploadComplete_"+a._setting.token,isShowPic:a._setting.isFlashShowPic},f={id:a._setting.token,name:a._setting.token};swfobject.embedSWF($.static("~/flash/upload.swf"),a._setting.token,"100%","100%","10.0.0",$.static("~/flash/expressInstall.swf"),g,h,f,function(){});window["onFlashUploadClick_"+a._setting.token]=function(){$(a._element).trigger($.fn.selectPhoto.events.CLICK,[])};window["onFlashUploadComplete_"+a._setting.token]=function(b){a._b64ToServerURL(b)};a._setting.useType="flash"}}console.log("useType: "+a._setting.useType)}})})