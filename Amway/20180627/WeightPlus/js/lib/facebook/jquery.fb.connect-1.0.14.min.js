(function(a){typeof define==="function"&&define.amd?define(["jquery","extend","fb"],a):a(jQuery)})(function(){var e=false,b=false;$.fb.connect=function(k){if(!e)return h(k);if(c)return;if(b)return;b=true;var i=$.Deferred();if(!FB.getAccessToken()){a.onLogin();$.loading(250);f();if(a.redirectAuthURL)$.delay(250).done(function(){location.href=$.fb.connect.url()});else $.fb.login(a.loginOption).done(function(e,c){g();$.delay(250).done(function(){$.loading("hide");d();var f=a.onSuccess(e,c);if($.isPlainObject(f))f.done(function(){i.resolve();b=false}).fail(function(){i.reject();b=false});else{i.resolve();b=false}})}).fail(function(){$.loading("hide");var c=a.onFail();if($.isPlainObject(c))c.always(function(){i.reject()});else{i.reject();b=false}})}else{d();var j=a.onSuccess(FB.getUserID(),FB.getAccessToken());if($.isPlainObject(j))j.done(function(){i.resolve();b=false}).fail(function(){i.reject();b=false});else{i.resolve();b=false}}return i.promise()};$.fb.connect.redirect=function(a){f();$.delay(250).done(function(){location.href=$.fb.connect.url(a)})};$.fb.connect.url=function(b){if(typeof b==typeof"")b={url:b};var c=$.extend({appID:a.appID,scope:$.val(a,"loginOption.scope"),url:a.redirectAuthURL||location.href},b||{});return"https://www.facebook.com/dialog/oauth?client_id="+encodeURIComponent(c.appID)+"&redirect_uri="+encodeURIComponent(c.url)+(c.scope?"&scope="+encodeURIComponent(c.scope):"")+"&response_type=token"};var a=$.fb.connect.settings={loginOption:undefined,appID:window.CONST?CONST.appID:undefined,redirectAuthURL:undefined,ga:$.isMobile?{login:["mobile","fb","login.frame"],auth:["mobile","fb","auth"]}:{login:["pc","fb","login.frame"],auth:["pc","fb","auth"]},onLogin:function(){},onSuccess:function(){},onFail:function(){}},c=false;function f(){window.ga&&ga.apply(null,["send","event"].concat(a.ga.login));window._gaq&&_gaq.push(["_trackEvent"].concat(a.ga.login))}function g(){window.ga&&ga.apply(null,["send","event"].concat(a.ga.auth));window._gaq&&_gaq.push(["_trackEvent"].concat(a.ga.auth))}function d(){FB.getAccessToken()&&$("form[signedRequest]").each(function(c,b){var a=$(b).find('input[name="SignedRequest"]');if(a.length==0)$('<input type="hidden" name="SignedRequest" />').val(FB.getAuthResponse().signedRequest).appendTo(b);else a.val(FB.getAuthResponse().signedRequest)})}function h(f){a=$.fb.connect.settings=$.extend({},$.fb.connect.settings,f);if(a.redirectAuthURL&&(/access_token=\w{100,}/.test(location.hash)||/error=.+/.test(location.search))){c=!/error=.+/.test(location.search);if(c){g();$.delay(250).done(function(){d();var b=a.onSuccess(FB.getUserID(),FB.getAccessToken());if($.isPlainObject(b))b.always(function(){c=false});else c=false})}else{var b=a.onFail();if($.isPlainObject(b))b.always(function(){c=false});else c=false}}e=true}})