(function(n){typeof define=="function"&&define.amd?define(["jquery","fb"],n):n(jQuery)})(function(){$.fb.fbapi={_api:function(n,t,i,r,u){var f=$.Deferred(),e;return $.fb.init().done(function(){$.fb.api(t,i).done(function(n){r(n,f)}).fail(function(n,t){u(n,t,f)})}),e=f.promise(),e.ResultName=n,e},_fql:function(n,t,i,r){return this._api(n,"/fql",{q:t},i,r)},name:function(n,t){var i=arguments.length==0||n==null||n.length==0,r=i?"select name from user where uid = me()":"select uid, name from user where uid in ("+n.join(",")+")";return this._fql("name",r,function(n,r){if(i)r.resolve($.val(n,"data.0.name"));else if(t){var u={};$.each(n.data,function(n,t){u[t.uid]=t.name});r.resolve(u)}else r.resolve(n.data)},function(n,t,r){r.resolve(i?"":[])})},pictureUrl:function(n,t){return typeof n!="string"&&typeof n!="number"&&(t=n,n=FB.getUserID()),"//graph.facebook.com/"+n+"/picture?"+$.param(t||{})},get:function(){var t={},n={};return $(arguments).each(function(i,r){t[r.ResultName]=0;n[r.ResultName]="running"}),$(arguments).each(function(i,r){r.done(function(i){t[r.ResultName]=i;n[r.ResultName]="ok"}).fail(function(t){n[r.ResultName]=t})}),{result:t,status:n,check:function(){for(var t in n)if(n[t]=="running")return!1;return!0}}},getFirendCount:function(){return this._fql("getFirendCount","select uid2 from friend where uid1 = me()",function(n,t){t.resolve(n.data?n.data.length:0)},function(n,t,i){i.resolve(0)})},getFriendWhosFanCount:function(n){var t="select uid from page_fan where page_id = "+n+" AND uid in (select uid2 from friend where uid1 = me())";return this._fql("getFriendWhosFanCount",t,function(n,t){t.resolve(n.data?n.data.length:0)},function(n,t,i){i.resolve(0)})},getJoinCompetingProductCount:function(n){var t=n.join(","),i="select uid from page_fan where page_id in ("+t+") AND uid = me()";return this._fql("getJoinCompetingProductCount",i,function(n,t){t.resolve(n.data?n.data.length:0)},function(n,t,i){i.resolve(0)})},getCheckinCount:function(n,t){var i="SELECT place FROM stream  WHERE source_id = me() and with_location > 0 limit "+t;return this._fql("getCheckinCount",i,function(t,i){var r=0;t.data&&$(t.data).each(function(t,i){$.inArray(""+i.place,n)>-1&&r++});i.resolve(r)},function(n,t,i){i.resolve(0)})},getKeywordMentionedCount:function(n,t){return this._api("getKeywordMentionedCount","/me/statuses",{fields:"message",limit:t},function(t,i){var r=0;t.data&&$(t.data).each(function(t,i){typeof i.message=="string"&&$(n).each(function(n,t){i.message.indexOf(t)>-1&&r++})});i.resolve(r)},function(n,t,i){i.resolve(0)})},getPopularPostCount:function(n,t){return this._api("getPopularPostCount","/me/statuses",{fields:"likes.fields(id),comments.fields(id)",limit:n},function(n,i){var r=0;n.data&&$(n.data).each(function(n,i){typeof i.likes=="undefined"&&(i.likes={data:[]});typeof i.comments=="undefined"&&(i.comments={data:[]});i.likes.data.length+i.comments.data.length>=t&&r++});i.resolve(r)},function(n,t,i){i.resolve(0)})},getRecentlyFriends:function(n){var i=this,t=$.Deferred();return n=Math.max(~~n||50,1),$.fb.api("me/posts",{limit:n||50}).then(function(n){var i={},r;if($.each(n.data||[],function(n,t){t=t||{};var r=t.likes||{};$.each(r.data||[],function(n,t){var r=t.id||"0",u=i[r]||{id:r,cnt:0};u.cnt++;i[r]=u});r=t.comments||{};$.each(r.data||[],function(n,t){t=t||{};t.form=t.form||{};var r=t.from.id||"0",u=i[r]||{id:r,cnt:0};u.cnt++;i[r]=u})}),r=$.map(i,function(n,t){return t}),r.length==0)return t.resolve([],"no posts found.");$.fb.fql("select uid2 from friend where uid1=me() and uid2 in ("+r.join(",")+")").done(function(n){var r=[],u;$.each(n.data,function(n,t){var u=i[t.uid2];u&&r.push(u)});r.sort(function(n,t){return t.cnt-n.cnt});u=$.map(r,function(n){return n.id});t.resolve(u)}).fail(function(n){t.resolve([],n)})}),t.promise()}}});